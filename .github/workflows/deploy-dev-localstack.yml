# Test deploy
name: Deploy to LocalStack EC2 (Dev)

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev
    types: [closed]
  workflow_dispatch:

env:
  TERRAFORM_VERSION: 1.6.0
  ENVIRONMENT: dev
  AWS_REGION: us-east-1
  LOCALSTACK_ENDPOINT: http://localhost:4567

jobs:
  deploy:
    name: Build and Deploy to LocalStack EC2
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check LocalStack health
        shell: pwsh
        run: |
          Write-Host "Checking LocalStack health..."
          $response = Invoke-WebRequest -Uri "http://localhost:4567/_localstack/health" -UseBasicParsing -ErrorAction Stop
          if ($response.StatusCode -eq 200) {
            Write-Host "✅ LocalStack is running"
          } else {
            Write-Host "❌ LocalStack health check failed"
            exit 1
          }

      - name: Generate image tags
        id: image-tags
        shell: pwsh
        run: |
          $SHORT_SHA = git rev-parse --short HEAD
          $TIMESTAMP = Get-Date -Format "yyyyMMdd-HHmmss"
          $IMAGE_TAG = "${ENVIRONMENT}-${SHORT_SHA}-${TIMESTAMP}"
          
          # Set GitHub outputs
          "app_image_tag=${IMAGE_TAG}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "consumer_image_tag=${IMAGE_TAG}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "ui_image_tag=${IMAGE_TAG}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "short_sha=${SHORT_SHA}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          Write-Host "Generated image tags:"
          Write-Host "  App: ${IMAGE_TAG}"
          Write-Host "  Consumer: ${IMAGE_TAG}"
          Write-Host "  UI: ${IMAGE_TAG}"

      - name: Build Docker images
        shell: pwsh
        run: |
          Write-Host "Building Docker images..."
          
          # Build app
          Write-Host "Building my-tiny-app..."
          docker build -t localhost/my-tiny-app:${{ steps.image-tags.outputs.app_image_tag }} ./my-tiny-app
          docker tag localhost/my-tiny-app:${{ steps.image-tags.outputs.app_image_tag }} localhost/my-tiny-app:${ENVIRONMENT}-latest
          
          # Build consumer
          Write-Host "Building my-tiny-app-consumer..."
          docker build -t localhost/my-tiny-app-consumer:${{ steps.image-tags.outputs.consumer_image_tag }} ./my-tiny-app-consumer
          docker tag localhost/my-tiny-app-consumer:${{ steps.image-tags.outputs.consumer_image_tag }} localhost/my-tiny-app-consumer:${ENVIRONMENT}-latest
          
          # Build UI
          Write-Host "Building my-tiny-app-ui..."
          docker build -t localhost/my-tiny-app-ui:${{ steps.image-tags.outputs.ui_image_tag }} ./my-tiny-app-ui
          docker tag localhost/my-tiny-app-ui:${{ steps.image-tags.outputs.ui_image_tag }} localhost/my-tiny-app-ui:${ENVIRONMENT}-latest
          
          Write-Host "✅ All images built successfully"
          
          # List images
          docker images | Select-String "localhost/my-tiny-app"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init - Infrastructure
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform init

      - name: Terraform Plan - Infrastructure
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform plan -out=tfplan

      - name: Terraform Apply - Infrastructure
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Init - Services
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform init

      - name: Terraform Plan - Services
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform plan \
            -var="app_image_tag=${{ steps.image-tags.outputs.app_image_tag }}" \
            -var="consumer_image_tag=${{ steps.image-tags.outputs.consumer_image_tag }}" \
            -var="ui_image_tag=${{ steps.image-tags.outputs.ui_image_tag }}" \
            -out=tfplan

      - name: Terraform Apply - Services
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform apply -auto-approve tfplan
          
          # Show outputs
          echo "Deployment outputs:"
          terraform output

      - name: Verify deployment
        shell: pwsh
        run: |
          Write-Host "Verifying deployment..."
          Start-Sleep -Seconds 10
          
          # Check EC2 instances
          aws --endpoint-url=${{ env.LOCALSTACK_ENDPOINT }} ec2 describe-instances `
            --region ${{ env.AWS_REGION }} `
            --filters "Name=tag:Name,Values=dev-my-tiny-app-server" `
            --query "Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key=='Name'].Value|[0]]" `
            --output table
          
          Write-Host "✅ Deployment verification completed"

      - name: Deployment summary
        if: always()
        shell: pwsh
        run: |
          @"
          ## Deployment Summary

          **Environment:** ${{ env.ENVIRONMENT }}
          **Commit:** ${{ steps.image-tags.outputs.short_sha }}
          **Image Tag:** ${{ steps.image-tags.outputs.app_image_tag }}

          ### Deployed Images:
          - App: ``localhost/my-tiny-app:${{ steps.image-tags.outputs.app_image_tag }}``
          - Consumer: ``localhost/my-tiny-app-consumer:${{ steps.image-tags.outputs.consumer_image_tag }}``
          - UI: ``localhost/my-tiny-app-ui:${{ steps.image-tags.outputs.ui_image_tag }}``
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

