# Test deploy
name: Deploy to LocalStack EC2 (Dev)

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev
    types: [closed]
  workflow_dispatch:

env:
  TERRAFORM_VERSION: 1.6.0
  ENVIRONMENT: dev
  AWS_REGION: us-east-1
  LOCALSTACK_ENDPOINT: http://localhost:4567

jobs:
  deploy:
    name: Build and Deploy to LocalStack EC2
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check LocalStack health
        shell: powershell
        run: |
          Write-Host "Checking LocalStack health..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:4567/_localstack/health" -UseBasicParsing -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "✅ LocalStack is running"
            } else {
              Write-Host "❌ LocalStack health check failed with status: $($response.StatusCode)"
              exit 1
            }
          } catch {
            Write-Host "❌ LocalStack is not accessible: $_"
            exit 1
          }

      - name: Generate image tags
        id: image-tags
        shell: powershell
        run: |
          $SHORT_SHA = (git rev-parse --short HEAD).Trim()
          $TIMESTAMP = Get-Date -Format "yyyyMMdd-HHmmss"
          $ENV_NAME = "${{ env.ENVIRONMENT }}"
          
          # Validate inputs
          if ([string]::IsNullOrWhiteSpace($ENV_NAME)) {
            Write-Host "❌ Error: ENVIRONMENT variable is empty"
            exit 1
          }
          
          if ([string]::IsNullOrWhiteSpace($SHORT_SHA)) {
            Write-Host "❌ Error: Could not get git short SHA"
            exit 1
          }
          
          # Construct image tag (ensure no leading/trailing dashes)
          $IMAGE_TAG = "$ENV_NAME-$SHORT_SHA-$TIMESTAMP"
          $IMAGE_TAG = $IMAGE_TAG.Trim('-')
          
          # Validate tag format (Docker tags cannot start with -)
          if ($IMAGE_TAG.StartsWith('-') -or [string]::IsNullOrWhiteSpace($IMAGE_TAG)) {
            Write-Host "❌ Error: Invalid image tag format: '$IMAGE_TAG'"
            exit 1
          }
          
          Write-Host "Generated image tags:"
          Write-Host "  Environment: $ENV_NAME"
          Write-Host "  Short SHA: $SHORT_SHA"
          Write-Host "  Timestamp: $TIMESTAMP"
          Write-Host "  Image Tag: $IMAGE_TAG"
          
          # Set GitHub outputs (format: key=value)
          "app_image_tag=$IMAGE_TAG" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "consumer_image_tag=$IMAGE_TAG" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "ui_image_tag=$IMAGE_TAG" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "short_sha=$SHORT_SHA" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          # Verify outputs were written
          Write-Host "Verifying outputs file..."
          Get-Content $env:GITHUB_OUTPUT | Write-Host

      - name: Build Docker images
        shell: powershell
        run: |
          Write-Host "Building Docker images..."
          
          $ENV_NAME = "${{ env.ENVIRONMENT }}"
          
          # Get image tags from previous step
          $APP_TAG = "${{ steps.image-tags.outputs.app_image_tag }}"
          $CONSUMER_TAG = "${{ steps.image-tags.outputs.consumer_image_tag }}"
          $UI_TAG = "${{ steps.image-tags.outputs.ui_image_tag }}"
          
          Write-Host "Image tags to use:"
          Write-Host "  App: $APP_TAG"
          Write-Host "  Consumer: $CONSUMER_TAG"
          Write-Host "  UI: $UI_TAG"
          
          # Validate tags are not empty
          if ([string]::IsNullOrWhiteSpace($APP_TAG) -or $APP_TAG.StartsWith('-')) {
            Write-Host "❌ Error: Invalid app_image_tag: '$APP_TAG'"
            exit 1
          }
          
          # Build app
          Write-Host "Building my-tiny-app..."
          docker build -t "localhost/my-tiny-app:$APP_TAG" ./my-tiny-app
          if ($LASTEXITCODE -ne 0) { exit 1 }
          docker tag "localhost/my-tiny-app:$APP_TAG" "localhost/my-tiny-app:${ENV_NAME}-latest"
          
          # Build consumer
          Write-Host "Building my-tiny-app-consumer..."
          docker build -t "localhost/my-tiny-app-consumer:$CONSUMER_TAG" ./my-tiny-app-consumer
          if ($LASTEXITCODE -ne 0) { exit 1 }
          docker tag "localhost/my-tiny-app-consumer:$CONSUMER_TAG" "localhost/my-tiny-app-consumer:${ENV_NAME}-latest"
          
          # Build UI
          Write-Host "Building my-tiny-app-ui..."
          docker build -t "localhost/my-tiny-app-ui:$UI_TAG" ./my-tiny-app-ui
          if ($LASTEXITCODE -ne 0) { exit 1 }
          docker tag "localhost/my-tiny-app-ui:$UI_TAG" "localhost/my-tiny-app-ui:${ENV_NAME}-latest"
          
          Write-Host "✅ All images built successfully"
          
          # List images
          docker images | Select-String "localhost/my-tiny-app"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init - Infrastructure
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform init

      - name: Terraform Plan - Infrastructure
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform plan -out=tfplan

      - name: Terraform Apply - Infrastructure
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/infrastructure
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Init - Services
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform init

      - name: Terraform Plan - Services
        shell: powershell
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform plan `
            -var="app_image_tag=${{ steps.image-tags.outputs.app_image_tag }}" `
            -var="consumer_image_tag=${{ steps.image-tags.outputs.consumer_image_tag }}" `
            -var="ui_image_tag=${{ steps.image-tags.outputs.ui_image_tag }}" `
            -out=tfplan

      - name: Terraform Apply - Services
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        shell: powershell
        working-directory: terraform/localstack/environments/${{ env.ENVIRONMENT }}/services
        run: |
          terraform apply -auto-approve tfplan
          
          # Show outputs
          Write-Host "Deployment outputs:"
          terraform output

      - name: Verify deployment
        shell: powershell
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
        run: |
          Write-Host "Verifying deployment..."
          Start-Sleep -Seconds 10
          
          # Set AWS credentials for LocalStack
          $env:AWS_ACCESS_KEY_ID = "test"
          $env:AWS_SECRET_ACCESS_KEY = "test"
          $env:AWS_DEFAULT_REGION = "${{ env.AWS_REGION }}"
          
          Write-Host "Checking EC2 instances..."
          
          # Check EC2 instances
          try {
            $result = aws --endpoint-url=${{ env.LOCALSTACK_ENDPOINT }} ec2 describe-instances `
              --region ${{ env.AWS_REGION }} `
              --filters "Name=tag:Name,Values=dev-my-tiny-app-server" `
              --query "Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key=='Name'].Value|[0]]" `
              --output table
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host $result
              Write-Host "✅ Deployment verification completed"
            } else {
              Write-Host "⚠️ Warning: Could not verify EC2 instances (exit code: $LASTEXITCODE)"
            }
          } catch {
            Write-Host "⚠️ Warning: Could not verify EC2 instances: $_"
          }

      - name: Deployment summary
        if: always()
        shell: powershell
        run: |
          $summary = @"
          ## Deployment Summary

          **Environment:** ${{ env.ENVIRONMENT }}
          **Commit:** ${{ steps.image-tags.outputs.short_sha }}
          **Image Tag:** ${{ steps.image-tags.outputs.app_image_tag }}

          ### Deployed Images:
          - App: ``localhost/my-tiny-app:${{ steps.image-tags.outputs.app_image_tag }}``
          - Consumer: ``localhost/my-tiny-app-consumer:${{ steps.image-tags.outputs.consumer_image_tag }}``
          - UI: ``localhost/my-tiny-app-ui:${{ steps.image-tags.outputs.ui_image_tag }}``
          "@
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

